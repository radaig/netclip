<head>
<link href="/static/toastui-editor.min.css" rel="stylesheet">
<script src="/static/toastui-editor-all.min.js"></script>
<script src="/static/socket.io.min.js"></script>
<style>
	.upload-indicator {
		position: fixed;
		top: 20px;
		right: 20px;
		background: #2196F3;
		color: white;
		padding: 12px 24px;
		border-radius: 4px;
		box-shadow: 0 2px 8px rgba(0,0,0,0.2);
		z-index: 9999;
		display: none;
	}
	.upload-indicator.show {
		display: block;
	}
	.upload-indicator.error {
		background: #f44336;
	}

	.container {
		display: flex;
		height: 100vh;
	}
	.editor-wrapper {
		flex: 1;
		display: flex;
		flex-direction: column;
	}
	.editor-container {
		flex: 1;
	}
	.sidebar {
		width: 250px;
		background: #f5f5f5;
		border-left: 1px solid #ddd;
		padding: 20px;
		overflow-y: auto;
	}
	.sidebar h3 {
		margin-top: 0;
		margin-bottom: 15px;
		font-size: 16px;
		color: #333;
	}
	.user-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	.user-item {
		padding: 8px 12px;
		margin-bottom: 5px;
		background: white;
		border-radius: 4px;
		display: flex;
		align-items: center;
	}
	.user-item.online::before {
		content: 'â—';
		color: #4CAF50;
		margin-right: 8px;
	}
	.room-info {
		background: white;
		padding: 12px;
		border-radius: 4px;
		margin-bottom: 20px;
	}
	.room-id {
		font-family: monospace;
		background: #f0f0f0;
		padding: 4px 8px;
		border-radius: 3px;
	}
	.room-link {
		color: #2196F3;
		text-decoration: none;
		word-break: break-all;
	}
	.room-link:hover {
		text-decoration: underline;
	}
	.status {
		color: #666;
		font-size: 12px;
		margin-top: 5px;
	}

	.password-modal {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		display: none;
		justify-content: center;
		align-items: center;
		z-index: 10000;
	}
	.password-modal.show {
		display: flex;
	}
	.password-box {
		background: white;
		padding: 30px;
		border-radius: 8px;
		max-width: 400px;
		width: 90%;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
	}
	.password-box h3 {
		margin-top: 0;
		margin-bottom: 20px;
		color: #333;
	}
	.password-box input[type="password"] {
		width: 100%;
		padding: 10px;
		font-size: 16px;
		border: 1px solid #ddd;
		border-radius: 4px;
		margin-bottom: 15px;
		box-sizing: border-box;
	}
	.password-box button {
		width: 100%;
		padding: 12px;
		background: #2196F3;
		color: white;
		border: none;
		border-radius: 4px;
		font-size: 16px;
		cursor: pointer;
	}
	.password-box button:hover {
		background: #1976D2;
	}
	.password-box .error {
		color: #f44336;
		margin-bottom: 10px;
		display: none;
	}
	.room-type {
		font-size: 13px;
		color: #4CAF50;
		margin-top: 8px;
	}
	.room-type.private {
		color: #FF9800;
	}

	/* æ–‡ä»¶å…±äº«æ ·å¼ */
	.file-section {
		margin-top: 20px;
		border-top: 1px solid #ddd;
		padding-top: 20px;
	}
	.file-section h3 {
		margin-top: 0;
		margin-bottom: 15px;
		font-size: 16px;
		color: #333;
	}
	.room-controls {
		background: white;
		padding: 12px;
		border-radius: 4px;
		margin-bottom: 20px;
	}
	.room-controls input[type="text"] {
		width: 100%;
		padding: 8px;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-size: 14px;
		margin-bottom: 8px;
		box-sizing: border-box;
	}
	.room-controls button {
		width: 100%;
		padding: 8px;
		background: #4CAF50;
		color: white;
		border: none;
		border-radius: 4px;
		font-size: 14px;
		cursor: pointer;
		margin-top: 5px;
	}
	.room-controls button:hover {
		background: #45a049;
	}
	.upload-section {
		background: white;
		padding: 12px;
		border-radius: 4px;
		margin-bottom: 15px;
	}
	.upload-btn {
		width: 100%;
		padding: 10px;
		background: #2196F3;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		margin-bottom: 10px;
	}
	.upload-btn:hover {
		background: #1976D2;
	}
	.progress-bar {
		width: 100%;
		height: 20px;
		background: #f0f0f0;
		border-radius: 10px;
		overflow: hidden;
		margin-bottom: 5px;
		display: none;
	}
	.progress-fill {
		height: 100%;
		background: #4CAF50;
		width: 0%;
		transition: width 0.3s;
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		font-size: 12px;
	}
	.progress-text {
		font-size: 12px;
		color: #666;
		text-align: center;
		margin-bottom: 5px;
		display: none;
	}
	.file-list {
		max-height: 300px;
		overflow-y: auto;
	}
	.file-item {
		background: #f9f9f9;
		padding: 10px;
		border-radius: 4px;
		margin-bottom: 8px;
		font-size: 13px;
	}
	.file-name {
		font-weight: bold;
		margin-bottom: 4px;
		word-break: break-all;
	}
	.file-meta {
		color: #666;
		font-size: 11px;
		margin-bottom: 4px;
	}
	.file-actions {
		display: flex;
		gap: 5px;
	}
	.file-actions button {
		padding: 4px 8px;
		font-size: 11px;
		border: none;
		border-radius: 3px;
		cursor: pointer;
	}
	.file-download {
		background: #4CAF50;
		color: white;
	}
	.file-delete {
		background: #f44336;
		color: white;
	}

	/* å“åº”å¼è®¾è®¡ - ç§»åŠ¨è®¾å¤‡é€‚é… */
	/* é€šè¿‡é•¿å®½æ¯”æ£€æµ‹æ‰‹æœºç«–å±ï¼šé«˜åº¦ > å®½åº¦ ä¸” æ¯”ä¾‹ > 1.5 */
	@media (max-width: 768px) and (orientation: portrait),
		   (max-aspect-ratio: 3/4) {
		.container {
			flex-direction: column;
			height: 100vh;
		}

		.editor-wrapper {
			flex: 1;
			min-height: 50vh;
		}

		.sidebar {
			width: 100%;
			border-left: none;
			border-top: 1px solid #ddd;
			padding: 15px;
			max-height: 50vh;
			overflow-y: auto;
		}

		.sidebar h3 {
			font-size: 14px;
			margin-bottom: 10px;
		}

		.room-controls input,
		.file-section input[type="file"] + button {
			font-size: 14px;
			padding: 8px;
		}

		button {
			padding: 8px 12px;
			font-size: 14px;
		}

		.user-item,
		.file-item {
			padding: 6px 10px;
			font-size: 13px;
		}

		.room-info {
			padding: 10px;
			font-size: 13px;
		}

		.upload-section button {
			width: 100%;
			margin-bottom: 10px;
		}

		.progress-bar {
			width: 100%;
		}
	}

	/* æ›´å°å±å¹•é€‚é… */
	@media (max-width: 480px) and (orientation: portrait) {
		.sidebar {
			padding: 10px;
		}

		.room-controls {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.room-controls input {
			width: 100%;
		}

		.sidebar h3 {
			font-size: 13px;
		}

		.user-item,
		.file-item,
		.room-info {
			font-size: 12px;
		}
	}

	/* æ¨ªå±æ‰‹æœºé€‚é…ï¼šä¿æŒæ°´å¹³å¸ƒå±€ */
	@media (max-width: 768px) and (orientation: landscape) {
		.container {
			flex-direction: row;
			height: 100vh;
		}

		.editor-wrapper {
			flex: 1;
		}

		.sidebar {
			width: 200px;
			border-left: 1px solid #ddd;
			border-top: none;
			max-height: 100vh;
		}
	}
</style>
</head>
<body>
	<div class="upload-indicator" id="uploadIndicator">ä¸Šä¼ ä¸­...</div>
	<div class="password-modal" id="passwordModal">
		<div class="password-box">
			<h3 id="passwordModalTitle">æˆ¿é—´å¯†ç </h3>
			<div class="error" id="passwordError">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
			<input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥æˆ¿é—´å¯†ç " onkeypress="if(event.key==='Enter') submitPassword()" />
			<button onclick="submitPassword()">ç¡®å®š</button>
		</div>
	</div>
	<div class="container" id="mainContainer" style="display: none;">
		<div class="editor-wrapper">
			<div id="editor" class="editor-container"></div>
		</div>
		<div class="sidebar">
			<h3>åä½œç¼–è¾‘</h3>

			<!-- æˆ¿é—´æ§åˆ¶ -->
			<div class="room-controls">
				<input type="text" id="roomIdInput" placeholder="è¾“å…¥æˆ¿é—´ID" />
				<input type="text" id="roomPasswordInput" placeholder="å¯†ç ï¼ˆå…¬å¼€æˆ¿é—´å¯é€‰ï¼‰" />
				<button onclick="createOrJoinRoom()">åˆ›å»º/åŠ å…¥æˆ¿é—´</button>
			</div>

			<div class="room-info">
				<div><strong>å½“å‰æˆ¿é—´:</strong> <span class="room-id" id="roomIdDisplay">-</span></div>
				<div class="room-type" id="roomType">å…¬å¼€æˆ¿é—´</div>
				<div class="status" id="connectionStatus">è¿æ¥ä¸­...</div>
			</div>

			<h3>åœ¨çº¿ç”¨æˆ· (<span id="userCount">0</span>)</h3>
			<ul class="user-list" id="userList"></ul>

			<!-- æ–‡ä»¶å…±äº«åŒºåŸŸ -->
			<div class="file-section">
				<h3>ğŸ“ æ–‡ä»¶å…±äº«</h3>

				<div class="upload-section">
					<input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" />
					<button class="upload-btn" onclick="document.getElementById('fileInput').click()">
						ä¸Šä¼ æ–‡ä»¶
					</button>
					<div class="progress-bar" id="progressBar">
						<div class="progress-fill" id="progressFill">0%</div>
					</div>
					<div class="progress-text" id="progressText"></div>
				</div>

				<div class="file-list" id="fileList">
					<!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€åŠ è½½ -->
				</div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
		// å…¨å±€å˜é‡
		var roomId, username, sessionId, currentPassword;
		var socket;
		var isApplyingRemoteUpdate = false;
		var editorInstance;

		// ç”Ÿæˆå‹å¥½ç”¨æˆ·å
		function generateNiceUsername() {
			var adjectives = ['å¸…æ°”', 'ç¾ä¸½', 'èªæ˜', 'å¯çˆ±', 'å¹½é»˜', 'æ¸©æŸ”', 'é˜³å…‰', 'ä¼˜é›…', 'æ´»æ³¼', 'å†·é™'];
			var nouns = ['å°çº¢', 'å°æ˜', 'å°çŒ«', 'å°ç‹—', 'å°é¸Ÿ', 'å°å…”å­', 'å°ç†ŠçŒ«', 'å°ç‹ç‹¸', 'å°é¹¿', 'å°è±¡'];
			var adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
			var noun = nouns[Math.floor(Math.random() * nouns.length)];
			return adjective + 'çš„' + noun;
		}

		// è·å–æˆ–åˆ›å»ºä¼šè¯ID
		function getOrCreateSessionId() {
			var sessionId = localStorage.getItem('collab_session_id');
			if (!sessionId) {
				sessionId = 'sess_' + Math.random().toString(36).substr(2, 16);
				localStorage.setItem('collab_session_id', sessionId);
			}
			return sessionId;
		}

		// ä»è·¯å¾„è·å–æˆ¿é—´ID
		function getRoomIdFromPath() {
			var path = window.location.pathname;
			var parts = path.split('/');
			if (parts.length > 1 && parts[1] && parts[1].length > 0 && parts[1] !== 'tuieditor.html') {
				return parts[1];
			}
			var params = new URLSearchParams(window.location.search);
			var password = params.get('password');
			if (password) {
				currentPassword = password;
			}
			return params.get('room') || 'public';
		}

		// æ–‡ä»¶å…±äº«åŠŸèƒ½éœ€è¦çš„å…¨å±€å‡½æ•°
		function createOrJoinRoom() {
			var newRoomId = document.getElementById('roomIdInput').value.trim();
			var password = document.getElementById('roomPasswordInput').value;

			if (!newRoomId) {
				alert('è¯·è¾“å…¥æˆ¿é—´ID');
				return;
			}

			if (newRoomId === roomId) {
				alert('å·²ç»åœ¨å½“å‰æˆ¿é—´');
				return;
			}

			// å…ˆæ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
			fetch('/api/room/verify', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					room_id: newRoomId,
					password: '',
					session_id: sessionId
				})
			})
			.then(function(response) {
				return response.json();
			})
			.then(function(data) {
				if (data.verified) {
					// æˆ¿é—´å­˜åœ¨ï¼Œç›´æ¥è·³è½¬
					if (password) {
						window.location.href = '/' + newRoomId + '?password=' + encodeURIComponent(password);
					} else {
						window.location.href = '/' + newRoomId;
					}
				} else {
					// æˆ¿é—´ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æˆ¿é—´
					createNewRoom(newRoomId, password);
				}
			})
			.catch(function(error) {
				console.error('æ£€æŸ¥æˆ¿é—´å¤±è´¥:', error);
				// å‡ºé”™æ—¶é»˜è®¤åˆ›å»ºæ–°æˆ¿é—´
				createNewRoom(newRoomId, password);
			});
		}

		function createNewRoom(roomId, password) {
			fetch('/api/room/create', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					room_id: roomId,
					password: password || ''
				})
			})
			.then(function(response) {
				return response.json();
			})
			.then(function(data) {
				if (data.room_id) {
					alert('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼');
					// ä¿å­˜å¯†ç åˆ°æœ¬åœ°
					if (password) {
						var savedPasswords = JSON.parse(localStorage.getItem('collab_passwords') || '{}');
						savedPasswords[data.room_id] = password;
						localStorage.setItem('collab_passwords', JSON.stringify(savedPasswords));
					}
					// è·³è½¬åˆ°æ–°æˆ¿é—´
					if (password) {
						window.location.href = '/' + data.room_id + '?password=' + encodeURIComponent(password);
					} else {
						window.location.href = '/' + data.room_id;
					}
				} else {
					alert('æˆ¿é—´åˆ›å»ºå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			})
			.catch(function(error) {
				console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error);
				alert('åˆ›å»ºæˆ¿é—´å¤±è´¥: ' + error.message);
			});
		}

		function uploadFile() {
			var fileInput = document.getElementById('fileInput');
			var file = fileInput.files[0];

			if (!file) return;

			// å…è®¸çš„æ–‡ä»¶ç±»å‹ - æ‰©å±•åå’ŒMIMEç±»å‹åŒé‡éªŒè¯
			var allowedTypes = {
				// å›¾ç‰‡
				'jpg': 'image/jpeg',
				'jpeg': 'image/jpeg',
				'png': 'image/png',
				'gif': 'image/gif',
				'webp': 'image/webp',
				'svg': 'image/svg+xml',
				// æ–‡æ¡£
				'txt': 'text/plain',
				'md': 'text/markdown',
				'pdf': 'application/pdf',
				'doc': 'application/msword',
				'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
				'xls': 'application/vnd.ms-excel',
				'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
				'ppt': 'application/vnd.ms-powerpoint',
				'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
				// å‹ç¼©æ–‡ä»¶
				'zip': 'application/zip',
				'rar': 'application/x-rar-compressed',
				'7z': 'application/x-7z-compressed',
				// ä»£ç æ–‡ä»¶
				'js': 'text/javascript',
				'json': 'application/json',
				'html': 'text/html',
				'htm': 'text/html',
				'css': 'text/css',
				'xml': 'text/xml',
				'py': 'text/x-python',
				'java': 'text/x-java-source',
				// éŸ³é¢‘æ–‡ä»¶
				'mp3': 'audio/mpeg',
				'wav': 'audio/wav',
				'ogg': 'audio/ogg',
				// è§†é¢‘æ–‡ä»¶
				'mp4': 'video/mp4',
				'avi': 'video/x-msvideo',
				'mov': 'video/quicktime',
				'wmv': 'video/x-ms-wmv'
			};

			var fileName = file.name;
			var fileExtension = fileName.split('.').pop().toLowerCase();
			var fileMimeType = file.type;

			// æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
			if (!allowedTypes.hasOwnProperty(fileExtension)) {
				alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ‰©å±•åï¼\n\nå…è®¸çš„ç±»å‹ï¼š\nâ€¢ å›¾ç‰‡ï¼šJPG, PNG, GIF, WebP, SVG\nâ€¢ æ–‡æ¡£ï¼šPDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, MD\nâ€¢ å‹ç¼©ï¼šZIP, RAR, 7Z\nâ€¢ ä»£ç ï¼šJS, JSON, HTML, CSS, XML, PY, JAVA\nâ€¢ éŸ³é¢‘ï¼šMP3, WAV, OGG\nâ€¢ è§†é¢‘ï¼šMP4, AVI, MOV, WMV');
				return;
			}

			// éªŒè¯MIMEç±»å‹ï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
			var expectedMimeType = allowedTypes[fileExtension];
			if (fileMimeType && fileMimeType !== expectedMimeType) {
				alert('æ–‡ä»¶MIMEç±»å‹ä¸åŒ¹é…ï¼è¯·ç¡®ä¿æ–‡ä»¶æœªæŸåã€‚');
				return;
			}

			// æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæ ¹æ®ç±»å‹ä¸åŒé™åˆ¶ä¸åŒï¼‰
			var maxSize = 50 * 1024 * 1024; // 50MB é»˜è®¤
			var largeFileTypes = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'zip', 'rar', '7z', 'mp4', 'avi', 'mov', 'wmv'];
			if (largeFileTypes.indexOf(fileExtension) !== -1) {
				maxSize = 100 * 1024 * 1024; // 100MB for large files
			}
			var imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
			if (imageTypes.indexOf(fileExtension) !== -1) {
				maxSize = 10 * 1024 * 1024; // 10MB for images
			}

			if (file.size > maxSize) {
				alert('æ–‡ä»¶å¤§å°è¶…å‡ºé™åˆ¶ï¼å…è®¸çš„æœ€å¤§å¤§å°ï¼š' + (maxSize / 1024 / 1024).toFixed(0) + 'MB');
				return;
			}

			// æ£€æŸ¥æ–‡ä»¶åå®‰å…¨æ€§
			if (fileName.includes('..') || fileName.includes('/') || fileName.includes('\\') ||
				fileName.includes(':') || fileName.includes('*') || fileName.includes('?') ||
				fileName.includes('"') || fileName.includes('<') || fileName.includes('>') ||
				fileName.includes('|') || fileName.includes('~') || fileName.includes('$')) {
				alert('æ–‡ä»¶ååŒ…å«éæ³•å­—ç¬¦ï¼');
				return;
			}

			// æ£€æŸ¥æ–‡ä»¶åé•¿åº¦
			if (fileName.length > 100) {
				alert('æ–‡ä»¶åé•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦ï¼');
				return;
			}

			var formData = new FormData();
			formData.append('file', file);

			var progressBar = document.getElementById('progressBar');
			var progressFill = document.getElementById('progressFill');
			var progressText = document.getElementById('progressText');

			progressBar.style.display = 'block';
			progressText.style.display = 'block';
			progressFill.style.width = '0%';

			var xhr = new XMLHttpRequest();

			xhr.upload.addEventListener('progress', function(e) {
				if (e.lengthComputable) {
					var percent = Math.round((e.loaded / e.total) * 100);
					progressFill.style.width = percent + '%';
					progressFill.textContent = percent + '%';
					progressText.textContent = 'ä¸Šä¼ ä¸­: ' + formatFileSize(e.loaded) + ' / ' + formatFileSize(e.total);
				}
			});

			xhr.addEventListener('load', function() {
				if (xhr.status === 200) {
					var response = JSON.parse(xhr.responseText);
					if (response.success) {
						alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
						loadRoomFiles();
						fileInput.value = '';
					} else {
						alert('ä¸Šä¼ å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
					}
				} else {
					alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
				}
				progressBar.style.display = 'none';
				progressText.style.display = 'none';
			});

			xhr.addEventListener('error', function() {
				alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
				progressBar.style.display = 'none';
				progressText.style.display = 'none';
			});

			xhr.open('POST', '/api/room/' + roomId + '/upload');
			xhr.send(formData);
		}

		function downloadFile(fileId) {
			window.location.href = '/api/room/' + roomId + '/download/' + fileId;
		}

		function deleteFile(fileId) {
			if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
				return;
			}

			fetch('/api/room/' + roomId + '/delete/' + fileId, {
				method: 'DELETE'
			})
			.then(function(response) {
				return response.json();
			})
			.then(function(data) {
				if (data.success) {
					alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
					loadRoomFiles();
				} else {
					alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			})
			.catch(function(error) {
				console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
				alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
			});
		}

		function formatFileSize(bytes) {
			if (bytes === 0) return '0 Bytes';
			var k = 1024;
			var sizes = ['Bytes', 'KB', 'MB', 'GB'];
			var i = Math.floor(Math.log(bytes) / Math.log(k));
			return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
		}

		function escapeHtml(text) {
			var div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		document.addEventListener("DOMContentLoaded", function() {
			var editorElement = document.getElementById('editor');
			var uploadIndicator = document.getElementById('uploadIndicator');
			var roomIdDisplay = document.getElementById('roomIdDisplay');
			var connectionStatus = document.getElementById('connectionStatus');
			var userCount = document.getElementById('userCount');
			var userList = document.getElementById('userList');
			var passwordModal = document.getElementById('passwordModal');
			var passwordInput = document.getElementById('passwordInput');
			var passwordError = document.getElementById('passwordError');
			var passwordModalTitle = document.getElementById('passwordModalTitle');
			var roomType = document.getElementById('roomType');
			var mainContainer = document.getElementById('mainContainer');

			// åˆå§‹åŒ–å…¨å±€å˜é‡
			username = generateNiceUsername();
			roomId = getRoomIdFromPath();
			sessionId = getOrCreateSessionId();

			function showPasswordModal(title) {
				passwordModalTitle.textContent = title || 'æˆ¿é—´å¯†ç ';
				passwordError.style.display = 'none';
				passwordInput.value = '';
				passwordModal.classList.add('show');
				passwordInput.focus();
			}

			function hidePasswordModal() {
				passwordModal.classList.remove('show');
			}

			function checkRoomPassword() {
				if (roomId === 'public') {
					// é»˜è®¤å…¬å¼€æˆ¿é—´ä¸éœ€è¦å¯†ç 
					mainContainer.style.display = 'flex';
					initApp();
					return;
				}

				// å¦‚æœURLä¸­æä¾›äº†å¯†ç ï¼Œç›´æ¥éªŒè¯
				if (currentPassword) {
					verifyPassword(currentPassword);
					return;
				}

				// æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨åŠç±»å‹
				fetch('/api/room/verify', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						room_id: roomId,
						password: '',
						session_id: sessionId
					})
				})
				.then(function(response) {
					return response.json();
				})
				.then(function(data) {
					if (!data.exists) {
						// æˆ¿é—´ä¸å­˜åœ¨ï¼Œè·³è½¬åˆ°publicæˆ¿é—´
						alert('æˆ¿é—´ "' + roomId + '" ä¸å­˜åœ¨ï¼å³å°†è·³è½¬åˆ°å…¬å¼€æˆ¿é—´...');
						window.location.href = '/public';
						return;
					}

					if (data.verified && data.is_public) {
						// å…¬å¼€æˆ¿é—´ï¼Œæ— éœ€å¯†ç ï¼Œç›´æ¥è¿›å…¥
						mainContainer.style.display = 'flex';
						initApp();
					} else if (data.verified && !data.is_public) {
						// ç§å¯†æˆ¿é—´ï¼Œæ£€æŸ¥æœ¬åœ°å¯†ç 
						var savedPasswords = JSON.parse(localStorage.getItem('collab_passwords') || '{}');
						if (savedPasswords[roomId]) {
							currentPassword = savedPasswords[roomId];
							verifyPassword(currentPassword);
						} else {
							// æˆ¿é—´å­˜åœ¨ä½†éœ€è¦å¯†ç 
							showPasswordModal('è¯·è¾“å…¥æˆ¿é—´å¯†ç ');
						}
					} else if (!data.verified && data.exists) {
						// æˆ¿é—´å­˜åœ¨ä½†å¯†ç é”™è¯¯
						alert('å¯†ç é”™è¯¯ï¼');
						showPasswordModal('è¯·è¾“å…¥æˆ¿é—´å¯†ç ');
					}
				})
				.catch(function(error) {
					console.error('æ£€æŸ¥æˆ¿é—´å¤±è´¥:', error);
					// é”™è¯¯æƒ…å†µä¸‹è·³è½¬åˆ°publicæˆ¿é—´
					alert('æˆ¿é—´ "' + roomId + '" ä¸å­˜åœ¨ï¼å³å°†è·³è½¬åˆ°å…¬å¼€æˆ¿é—´...');
					window.location.href = '/public';
				});
			}

			function verifyPassword(password) {
				fetch('/api/room/verify', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						room_id: roomId,
						password: password,
						session_id: sessionId
					})
				})
				.then(function(response) {
					return response.json();
				})
				.then(function(data) {
					if (data.verified) {
						// å¯†ç æ­£ç¡®
						currentPassword = password;
						hidePasswordModal();
						mainContainer.style.display = 'flex';
						initApp();

						// ä¿å­˜å¯†ç åˆ°æœ¬åœ°
						if (password) {
							var savedPasswords = JSON.parse(localStorage.getItem('collab_passwords') || '{}');
							savedPasswords[roomId] = password;
							localStorage.setItem('collab_passwords', JSON.stringify(savedPasswords));
						}
					} else {
						// å¯†ç é”™è¯¯
						passwordError.textContent = data.message || 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
						passwordError.style.display = 'block';
						passwordInput.focus();
					}
				})
				.catch(function(error) {
					console.error('éªŒè¯å¯†ç å¤±è´¥:', error);
					passwordError.textContent = 'éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•';
					passwordError.style.display = 'block';
				});
			}

			window.submitPassword = function() {
				var password = passwordInput.value;
				if (roomId === 'public') {
					// publicæˆ¿é—´ä¸éœ€è¦å¯†ç ï¼Œç›´æ¥è¿›å…¥
					hidePasswordModal();
					mainContainer.style.display = 'flex';
					initApp();
				} else if (roomId === 'default' || password) {
					verifyPassword(password);
				} else {
					// åˆ›å»ºæ–°æˆ¿é—´
					createRoom(password);
				}
			};

			function createRoom(password) {
				fetch('/api/room/create', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ password: password })
				})
				.then(function(response) {
					return response.json();
				})
				.then(function(data) {
					if (data.room_id) {
						currentPassword = password;
						hidePasswordModal();
						mainContainer.style.display = 'flex';
						initApp();

						// ä¿å­˜å¯†ç åˆ°æœ¬åœ°
						if (password) {
							var savedPasswords = JSON.parse(localStorage.getItem('collab_passwords') || '{}');
							savedPasswords[data.room_id] = password;
							localStorage.setItem('collab_passwords', JSON.stringify(savedPasswords));
						}

						// æ›´æ–°URL
						window.history.replaceState({}, '', '/' + data.room_id);
					}
				})
				.catch(function(error) {
					console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error);
				});
			}

			function showUploadIndicator(message, isError) {
				uploadIndicator.textContent = message;
				uploadIndicator.className = 'upload-indicator show' + (isError ? ' error' : '');
				setTimeout(function() {
					uploadIndicator.className = 'upload-indicator';
				}, 3000);
			}

			function updateUserList(users) {
				userCount.textContent = users.length;
				userList.innerHTML = '';
				users.forEach(function(user) {
					var li = document.createElement('li');
					li.className = 'user-item online';
					li.textContent = user;
					userList.appendChild(li);
				});
			}

			function updateRoomInfo(isPublic) {
				roomIdDisplay.textContent = roomId;
				if (isPublic) {
					roomType.textContent = 'å…¬å¼€æˆ¿é—´';
					roomType.className = 'room-type';
				} else {
					roomType.textContent = 'ç§å¯†æˆ¿é—´ï¼ˆéœ€å¯†ç ï¼‰';
					roomType.className = 'room-type private';
				}
				if (roomId !== 'public') {
					var link = window.location.origin + '/' + roomId;
					var linkElement = document.createElement('div');
					linkElement.innerHTML = '<strong>åˆ†äº«é“¾æ¥:</strong><br><a href="' + link + '" class="room-link" target="_blank">' + link + '</a>';
					var roomInfoDiv = document.querySelector('.room-info');
					// ç§»é™¤æ—§é“¾æ¥
					var existingLink = roomInfoDiv.querySelector('.room-link');
					if (existingLink) {
						existingLink.parentElement.remove();
					}
					roomInfoDiv.appendChild(linkElement);
				}
			}

			function initApp() {
				// åˆå§‹åŒ–ç¼–è¾‘å™¨
				var editorInstance = new toastui.Editor({
					el: editorElement,
					height: '100%',
					hooks: {
					addImageBlobHook: function(file, successCallback, errorCallback){
						console.log('Image upload triggered:', file.name, file.type);

						// æ˜¾ç¤ºä¸Šä¼ æŒ‡ç¤ºå™¨
						showUploadIndicator('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', false);

						// å°†æ–‡ä»¶æ•°æ®ä¸Šä¼ è‡³æœåŠ¡å™¨
						var formData = new FormData();
						formData.append('image', file);

						// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸå
						fetch('/upload-image', {
							method: 'POST',
							body: formData
						}).then(function(response){
							response.json().then(function(data){
								if (data && data.url) {
									console.log('Image uploaded successfully:', data.url);
									showUploadIndicator('ä¸Šä¼ æˆåŠŸï¼', false);
									// è¿”å›å®Œæ•´URLç»™ç¼–è¾‘å™¨
									var fullUrl = window.location.origin + data.url;
									successCallback(fullUrl);
								} else {
									console.error('Upload failed:', data);
									showUploadIndicator('ä¸Šä¼ å¤±è´¥ï¼', true);
									errorCallback('Failed uploading image');
								}
							}).catch(function(error){
								console.error('Response parse error:', error);
								showUploadIndicator('ä¸Šä¼ å¤±è´¥ï¼', true);
								errorCallback('Failed uploading image');
							})
						}).catch(function(error){
							console.error('Upload error:', error);
							showUploadIndicator('ä¸Šä¼ å¤±è´¥ï¼', true);
							errorCallback('Failed uploading image');
						})
					}
				},
				initialValue: '',
				previewStyle: 'vertical'
			});

			// åˆå§‹åŒ– WebSocket è¿æ¥
			function initWebSocket() {
				socket = io();

				// è¿æ¥äº‹ä»¶
				socket.on('connect', function() {
					console.log('WebSocket connected');
					connectionStatus.textContent = 'å·²è¿æ¥';
					connectionStatus.style.color = '#4CAF50';

					// åŠ å…¥æˆ¿é—´
					socket.emit('join', {
						room: roomId,
						username: username,
						password: currentPassword,
						session_id: sessionId
					});

					updateRoomInfo(true);
				});

				// å¯†ç éªŒè¯å¤±è´¥
				socket.on('auth_failed', function(data) {
					console.error('è®¤è¯å¤±è´¥:', data.message);
					showPasswordModal(data.message || 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
				});

				socket.on('disconnect', function() {
					console.log('WebSocket disconnected');
					connectionStatus.textContent = 'å·²æ–­å¼€è¿æ¥';
					connectionStatus.style.color = '#f44336';
				});

				// æ¥æ”¶åˆå§‹å†…å®¹
				socket.on('init_content', function(data) {
					console.log('Received initial content:', data.content);
					if (data.content && data.content.trim() !== '') {
						isApplyingRemoteUpdate = true;
						editorInstance.setMarkdown(data.content);
						isApplyingRemoteUpdate = false;
					}
				});

				// æ¥æ”¶å†…å®¹æ›´æ–°
				socket.on('content_update', function(data) {
					console.log('Received content update from', data.username);
					isApplyingRemoteUpdate = true;
					editorInstance.setMarkdown(data.content);
					isApplyingRemoteUpdate = false;
				});

				// æ¥æ”¶ç”¨æˆ·åˆ—è¡¨æ›´æ–°ï¼ˆç”¨äºåˆå§‹åŒ–å’ŒåŒæ­¥ï¼‰
				socket.on('user_list_update', function(data) {
					console.log('User list update:', data.users);
					updateUserList(data.users);
				});

				// ç”¨æˆ·åŠ å…¥
				socket.on('user_joined', function(data) {
					console.log('User joined:', data.username);
					updateUserList(data.users);
					showUploadIndicator(data.username + ' åŠ å…¥äº†ç¼–è¾‘', false);
				});

				// ç”¨æˆ·ç¦»å¼€
				socket.on('user_left', function(data) {
					console.log('User left:', data.username);
					updateUserList(data.users);
					showUploadIndicator(data.username + ' ç¦»å¼€äº†ç¼–è¾‘', false);
				});

				// æ¥æ”¶å…‰æ ‡ä½ç½®æ›´æ–°
				socket.on('cursor_update', function(data) {
					console.log('Cursor update from', data.username, 'position:', data.position);
				});
			}

			// ç›‘å¬å†…å®¹å˜åŒ–
			editorInstance.on('change', function() {
				if (isApplyingRemoteUpdate) return;  // å¦‚æœæ˜¯è¿œç¨‹æ›´æ–°ï¼Œä¸å‘é€

				var content = editorInstance.getMarkdown();
				if (socket && socket.connected) {
					console.log('Sending content change');
					socket.emit('content_change', {
						room: roomId,
						content: content
					});
				}
			});

			// ç›‘å¬å…‰æ ‡å˜åŒ–
			editorInstance.on('blur', function() {
				if (socket && socket.connected) {
					var cursorPos = editorInstance.getSelection().index;
					socket.emit('cursor_move', {
						room: roomId,
						position: cursorPos
					});
				}
			});

			// é¢å¤–æ·»åŠ  paste äº‹ä»¶ç›‘å¬å™¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
			var editorContainer = editorElement.querySelector('.toastui-editor');
			if (editorContainer) {
				editorContainer.addEventListener('paste', function(e) {
					console.log('Paste event detected');
					var items = e.clipboardData && e.clipboardData.items;
					if (!items) return;

					for (var i = 0; i < items.length; i++) {
						if (items[i].type.indexOf('image') !== -1) {
							var file = items[i].getAsFile();
							if (file) {
								console.log('Pasted image detected:', file);
								e.preventDefault();
								// æ‰‹åŠ¨è§¦å‘ addImageBlobHook
								editorInstance.getAction('uploadImage').exec(file);
							}
						}
					}
				});
			}

			// å¯åŠ¨ WebSocket
			initWebSocket();

			// åŠ è½½æˆ¿é—´æ–‡ä»¶åˆ—è¡¨
			loadRoomFiles();
		}

		// ========== æ–‡ä»¶å…±äº«åŠŸèƒ½ ==========

		function loadRoomFiles() {
			console.log('Loading files for room:', roomId);
			fetch('/api/room/' + roomId + '/files')
				.then(function(response) {
					return response.json();
				})
				.then(function(data) {
					console.log('Files loaded:', data.files);
					displayFiles(data.files || []);
				})
				.catch(function(error) {
					console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
				});
		}

		function displayFiles(files) {
			var fileList = document.getElementById('fileList');
			if (files.length === 0) {
				fileList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ–‡ä»¶</div>';
				return;
			}

			fileList.innerHTML = '';
			files.forEach(function(file) {
				var fileItem = document.createElement('div');
				fileItem.className = 'file-item';

				var sizeStr = formatFileSize(file.file_size);
				var dateStr = new Date(file.uploaded_at).toLocaleString('zh-CN');

				fileItem.innerHTML =
					'<div class="file-name">' + escapeHtml(file.original_filename) + '</div>' +
					'<div class="file-meta">å¤§å°: ' + sizeStr + ' | ä¸Šä¼ : ' + dateStr + '</div>' +
					(file.description ? '<div class="file-meta">æè¿°: ' + escapeHtml(file.description) + '</div>' : '') +
					'<div class="file-actions">' +
					'<button class="file-download" onclick="downloadFile(\'' + file.file_id + '\')">ä¸‹è½½</button>' +
					'<button class="file-delete" onclick="deleteFile(\'' + file.file_id + '\')">åˆ é™¤</button>' +
					'</div>';

				fileList.appendChild(fileItem);
			});
		}

		// å¯åŠ¨åº”ç”¨
		checkRoomPassword();
	});
    </script>
</body>
